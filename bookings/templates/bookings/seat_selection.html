{% extends 'base.html' %}

{% block title %}Select Seats{% endblock %}

{% block extra_css %}
<style>
    .seat-card {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem 0 rgba(0, 0, 0, 0.05);
        background-color: #ffffff;
    }

    /* Seat Map Grid: 3 seats | Aisle | 3 seats */
    .seat-map {
        display: grid;
        grid-template-columns: repeat(3, 1fr) 40px repeat(3, 1fr);
        gap: 10px;
        max-width: 500px;
        margin: 2rem auto;
        background-color: #f8f9fa;
        padding: 30px 20px;
        border-radius: 15px;
        border: 1px solid #dee2e6;
    }
    
    .seat {
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #555;
        background-color: #fff;
        border: 1px solid #ccc;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .seat.available:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        transform: scale(1.05);
    }

    .seat.selected {
        background-color: #0d6efd !important;
        color: #fff !important;
        border-color: #0d6efd !important;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
    }

    .seat.taken {
        background-color: #6c757d;
        color: #fff;
        border-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none;
    }

    .aisle-spacer { grid-column: auto; }
    .seat-label { text-align: center; font-size: 0.8rem; font-weight: bold; color: #6c757d; margin-bottom: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div id="alert-container"></div>

            <div class="mb-3">
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i> Back
                </a>
            </div>

            <div class="card seat-card">
                <div class="card-body p-4 p-sm-5">
                    
                    <div class="text-center mb-4">
                        <h2 class="fw-bold">Select Your Seats</h2>
                        <p class="text-muted mb-1">Flight {{ flight.flight_number }}</p>
                        <div class="badge bg-info text-dark fs-6 px-3 py-2">
                            Select {{ total_passengers }} Seat(s)
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-4 mb-4">
                        <div class="d-flex align-items-center"><div class="seat available" style="width: 25px; height: 25px;"></div><span class="ms-2 small">Available</span></div>
                        <div class="d-flex align-items-center"><div class="seat selected" style="width: 25px; height: 25px;"></div><span class="ms-2 small">Selected</span></div>
                        <div class="d-flex align-items-center"><div class="seat taken" style="width: 25px; height: 25px;"></div><span class="ms-2 small">Taken</span></div>
                    </div>
                    
                    <div class="seat-map">
                        <div class="seat-label">A</div><div class="seat-label">B</div><div class="seat-label">C</div>
                        <div class="aisle-spacer"></div>
                        <div class="seat-label">D</div><div class="seat-label">E</div><div class="seat-label">F</div>

                        {% for row in row_range %}
                            <div class="seat available" id="{{ row }}A" data-seat="{{ row }}A">{{ row }}A</div>
                            <div class="seat available" id="{{ row }}B" data-seat="{{ row }}B">{{ row }}B</div>
                            <div class="seat available" id="{{ row }}C" data-seat="{{ row }}C">{{ row }}C</div>
                            <div class="aisle-spacer"></div>
                            <div class="seat available" id="{{ row }}D" data-seat="{{ row }}D">{{ row }}D</div>
                            <div class="seat available" id="{{ row }}E" data-seat="{{ row }}E">{{ row }}E</div>
                            <div class="seat available" id="{{ row }}F" data-seat="{{ row }}F">{{ row }}F</div>
                        {% endfor %}
                    </div>

                    <div class="row justify-content-center mt-4">
                        <div class="col-md-8 text-center">
                            <p class="fs-5">Seats Selected: <strong class="text-primary" id="selectedCount">0</strong> / {{ total_passengers }}</p>
                            <h5 class="mb-3">Selected: <span id="selectedSeatsList" class="text-muted">None</span></h5>
                            
                            <form action="{% url 'passenger_details' %}" method="POST" id="seatForm">
                                {% csrf_token %}
                                <input type="hidden" name="flight_id" value="{{ flight.flight_number }}">
                                <input type="hidden" name="selected_seats" id="seatsInput">
                                
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary btn-lg disabled" id="confirmButton">
                                        Confirm Selection
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div> 
</div>

{{ total_passengers|json_script:"total-passengers-data" }}
{{ taken_seats|json_script:"taken-seats-data" }}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const passengersRequired = JSON.parse(document.getElementById('total-passengers-data').textContent);
        const takenSeats = JSON.parse(document.getElementById('taken-seats-data').textContent);

        const seats = document.querySelectorAll(".seat");
        const confirmBtn = document.getElementById("confirmButton");
        const selectedListEl = document.getElementById("selectedSeatsList");
        const selectedCountEl = document.getElementById("selectedCount");
        const seatsInput = document.getElementById("seatsInput");
        const alertContainer = document.getElementById("alert-container"); // (FIX 2) Get container
        
        let selectedSeats = [];

        // (FIX 3) Helper Function to Show Bootstrap Alerts
        function showAlert(message, type) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                `   <i class="bi bi-exclamation-circle-fill me-2"></i>${message}`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');
            
            alertContainer.innerHTML = ''; // Clear previous alerts
            alertContainer.append(wrapper);
            
            // Scroll to top to make sure user sees it
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Mark Taken Seats
        takenSeats.forEach(seatId => {
            const seatEl = document.getElementById(seatId);
            if (seatEl) {
                seatEl.classList.remove("available");
                seatEl.classList.add("taken");
                seatEl.setAttribute("title", "Occupied");
            }
        });

        // Click Handler
        seats.forEach(seat => {
            seat.addEventListener("click", function() {
                if (this.classList.contains("taken")) return;

                const seatId = this.getAttribute("data-seat");

                if (this.classList.contains("selected")) {
                    // Deselect
                    this.classList.remove("selected");
                    selectedSeats = selectedSeats.filter(s => s !== seatId);
                    alertContainer.innerHTML = ''; // Clear warnings on deselect
                } else {
                    // Select
                    if (selectedSeats.length < passengersRequired) {
                        this.classList.add("selected");
                        selectedSeats.push(seatId);
                        alertContainer.innerHTML = ''; // Clear warnings on valid select
                    } else {
                        // (FIX 4) Use showAlert instead of alert()
                        showAlert(`You can only select ${passengersRequired} seats. Please deselect one first.`, 'warning');
                    }
                }
                updateUI();
            });
        });

        function updateUI() {
            selectedCountEl.textContent = selectedSeats.length;
            selectedListEl.textContent = selectedSeats.length > 0 ? selectedSeats.join(", ") : "None";
            seatsInput.value = selectedSeats.join(",");

            if (selectedSeats.length === passengersRequired) {
                confirmBtn.classList.remove("disabled");
                confirmBtn.removeAttribute("disabled");
            } else {
                confirmBtn.classList.add("disabled");
                confirmBtn.setAttribute("disabled", "true");
            }
        }

        confirmBtn.addEventListener("click", function() {
            if (!this.classList.contains("disabled")) {
                // (FIX 5) Show success alert before submitting
                showAlert("Seats confirmed! Proceeding to payment...", "success");
                // Uncomment this when payment page is ready:
                document.getElementById("seatForm").submit();
            }
        });
    });
</script>
{% endblock %}